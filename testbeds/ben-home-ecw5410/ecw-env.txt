# Seems ECW can lose its environment sometimes, here is a proper environment:
# For whatever reason, I can only paste about two lines at a time...more and sometimes
# the bootloader seems to silently crash.

setenv active '1'
setenv altbootcmd 'if test $changed = 0; then run do_change; else run do_recovery; fi'
setenv args_common 'root=mtd:ubi_rootfs rootfstype=squashfs'
setenv boot1 'echo Booting from partition: ${partname}'
setenv boot2 'nand device 1 && set mtdids nand0=nand0'
setenv boot3 'set mtdparts mtdparts=nand0:0x4000000@0x0(fs1),0x4000000@0x4000000(fs2)'
setenv boot4 'ubi part fs${partname} && ubi read 44000000 kernel'
setenv boot5 'cfgsel 44000000 && run bootfdtcmd'
setenv bootargs 'console=ttyHSL1,115200n8'
setenv bootcmd 'run setup && run bootlinux'
setenv bootdelay '2'
setenv bootlimit '3'
setenv bootlinux 'run boot1 boot2 boot3 boot4 boot5|| reset'
setenv change1 'if test $active = 1; then setenv active 2; else setenv active 1; fi'
setenv change2 'setenv bootcount; setenv changed 1; saveenv'
setenv change3 'echo Active partition changed to [$active]'
setenv do_change 'run change1 change2 change3; reset'
setenv do_lub 'run lub1 lub2 lub3'
setenv do_recovery 'run rec1 rec2 rec3 rec4 rec5 rec6 rec7 rec8; reset'
setenv eth1addr '3c:2c:99:f4:51:63'
setenv ethact 'eth0'
setenv ethaddr '3c:2c:99:f4:51:62'
setenv lub1 'tftpboot ${tftp_loadaddr} ${ub_file}'
setenv lub2 'sf probe && sf erase 0x100000 0x70000'
setenv lub3 'sf write ${tftp_loadaddr} 0x100000 ${filesize}'
setenv machid '136b'
setenv rec1 'echo Doing firmware recovery!'
setenv rec2 'setenv active 1 && setenv changed 0 && setenv bootcount 0'
setenv rec3 'saveenv'
setenv rec4 'sleep 2 && tftpboot ${tftp_loadaddr} ${recovery_file}'
setenv rec5 'imxtract ${tftp_loadaddr} ubi'
setenv rec6 'nand device 1 && nand erase.chip'
setenv rec7 'nand write ${fileaddr} 0x0 ${filesize}'
setenv rec8 'nand write ${fileaddr} 0x4000000 ${filesize}'
setenv recovery_file 'fwupdate.bin'
setenv setup 'if test $active = 1; then run setup1; else run setup2; fi'
setenv setup1 'partname=1 && setenv bootargs ubi.mtd=rootfs${partname} ${args_common}'
setenv setup2 'partname=2 && setenv bootargs ubi.mtd=rootfs${partname} ${args_common}'
setenv stderr 'serial'
setenv stdin 'serial'
setenv stdout 'serial'
setenv tftp_loadaddr '0x42000000'
setenv ub_file 'openwrt-ipq806x-u-boot.mbn'
setenv upgrade_available '1'
setenv bootcount '0'
saveenv
setenv baudrate '115200'
